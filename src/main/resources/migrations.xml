<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author="hpitelka">
        <createTable tableName="people">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)" />
			<column name="status" type="int" />
			<column name="emailAddress" type="varchar(255)" />
			<column name="phoneNumber" type="varchar(100)" />
			<column name="rank" type="varchar(255)" />
			<column name="biography" type="text" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="role" type="int" >
                <constraints nullable="false"/>
			</column>
			<column name="pendingVerification" type="boolean" defaultValue="false" />
        </createTable>

		<createTable tableName="groups">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
			<column name="name" type="varchar(512)" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="groupMemberships">
			<column name="groupId" type="int" />
			<column name="personId" type="int" />
		</createTable>

		<createTable tableName="organizations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)" />
			<column name="parentOrgId" type="int" />

			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="poams" >
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			
			<!-- the 1-2 character version (ie EF-5, or B) -->
			<column name="shortName" type="varchar(100)" /> 
			
			<!-- The Longer text ie (Rule of Law) or (Get the MoI to handle hiring of people) -->
			<column name="longName" type="varchar(255)" /> 
			
			<!-- What type of POAM this is EF, Sub-EF, Milestone, Action, Sub-Action -->
			<column name="category" type="varchar(255)" />

			<!-- the POAM id of the parent of this POAM. null for top level (ie EF/DA) -->
			<column name="parentPoamId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<createTable tableName="positions">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="code" type="varchar(100)" />
			<column name="name" type="varchar(512)" />
			<column name="organizationId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
                <constraints nullable="false"/>
			</column>
			<column name="currentPersonId" type="int" />
			<column name="locationId" type="int" />
		</createTable>

		<createTable tableName="peoplePositions">
			<column name="positionId" type="int" />
			<column name="personId" type="int" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="positionRelationships" >
			<column name="positionId_a" type="int" />
			<column name="positionId_b" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="deleted" type="boolean" />
		</createTable>

		<createTable tableName="reports">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="locationId" type="int" />
			<column name="intent" type="text" />
			<column name="exsum" type="text" />
			<column name="text" type="text" />
			<column name="nextSteps" type="text" />
			<column name="authorId" type="int" />
			<column name="approvalStepId" type="int" />
			<column name="state" type="int" />
			<column name="engagementDate" type="datetime"/>
			<column name="atmosphere" type="int"/>
			<column name="atmosphereDetails" type="text" />
		</createTable>

		<createTable tableName="reportPeople" >
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="isPrimary" type="boolean" defaultValue="false" />
		</createTable>
		<createTable tableName="reportPoams" >
			<column name="reportId" type="int" />
			<column name="poamId" type="int" />
		</createTable>

		<createTable tableName="comments">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="text" type="text" />
		</createTable>

		<createTable tableName="locations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(500)" />
			<column name="lat" type="float" />
			<column name="lng" type="float" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
    </changeSet>

	<changeSet id="2" author="hpitelka">
		<createTable tableName="approvalSteps">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="approverGroupId" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="nextStepId" type="int" />
			<column name="advisorOrganizationId" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="approvalActions">
			<column name="approvalStepId" type="int" />
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="type" type="int" />
		</createTable>
	</changeSet>

	<changeSet id="4" author="hpitelka" runInTransaction="false" >
		<sql dbms="mssql">
			CREATE FULLTEXT CATALOG anet_ft_catalog AS DEFAULT;
		</sql>
		<!-- Key name of PK_TABLE_NAME is autogenerated by Liquidbase on each table w/ a primary key -->
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails) KEY INDEX PK_REPORTS;
		</sql>
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_PEOPLE;
		</sql>
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_POSITIONS;
		</sql>
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON organizations(name) KEY INDEX PK_ORGANIZATIONS;
		</sql>
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_LOCATIONS;
		</sql>
	</changeSet>

	<changeSet id="5" author="hpitelka" >
		<sql dbms="mssql">
			ALTER TABLE people ALTER COLUMN createdAt datetime2;
			ALTER TABLE people ALTER COLUMN updatedAt datetime2;
			ALTER TABLE groups ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN updatedAt datetime2;
			
			ALTER TABLE poams ALTER COLUMN createdAt datetime2;
			ALTER TABLE poams ALTER COLUMN updatedAt datetime2;
			
			ALTER TABLE positions ALTER COLUMN createdAt datetime2;
			ALTER TABLE positions ALTER COLUMN updatedAt datetime2;
			
			ALTER TABLE peoplePositions ALTER COLUMN createdAt datetime2;
			
			ALTER TABLE positionRelationships ALTER COLUMN createdAt datetime2;
			ALTER TABLE positionRelationships ALTER COLUMN updatedAt datetime2;

			ALTER TABLE reports ALTER COLUMN createdAt datetime2;
			ALTER TABLE reports ALTER COLUMN updatedAt datetime2;
			ALTER TABLE reports ALTER COLUMN engagementDate datetime2;
			
			ALTER TABLE comments ALTER COLUMN createdAt datetime2;
			ALTER TABLE comments ALTER COLUMN updatedAt datetime2;
			
			ALTER TABLE locations ALTER COLUMN createdAt datetime2;
			ALTER TABLE locations ALTER COLUMN updatedAt datetime2;
			
			ALTER TABLE approvalActions ALTER COLUMN createdAt datetime2;
		</sql>
	</changeSet>
</databaseChangeLog>
